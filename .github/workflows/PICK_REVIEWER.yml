name: 'Pick Reviewer'

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  pick-random-reviewer:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Pick random reviewer
        id: pick_random_reviewer
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            const developers = JSON.parse(
              fs.readFileSync(`${{ github.workspace }}/.github/workflows/reviewer.json`, 'utf8')
            );

            const prCreator = context.payload.pull_request.user.login;
            const prUrl = context.payload.pull_request.html_url;

            const prCreatorJson = developers.reviewers.find(person => person.githubName === prCreator);
            const candidates = developers.reviewers.filter(person => person.githubName !== prCreator);

            function pickTwo(arr) {
              const a = arr[Math.floor(Math.random() * arr.length)];
              const rest = arr.filter(item => item !== a);
              const b = rest[Math.floor(Math.random() * rest.length)];
              return [a, b];
            }

            const [reviewer1, reviewer2] = pickTwo(candidates);

            core.setOutput('writer', prCreatorJson?.name ?? prCreator);
            core.setOutput('pullRequestLink', prUrl);
            core.setOutput('reviewer1Name', reviewer1.name);
            core.setOutput('reviewer2Name', reviewer2.name);
            core.setOutput('reviewer1GithubName', reviewer1.githubName);
            core.setOutput('reviewer2GithubName', reviewer2.githubName);

      - name: test variable
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            console.log("reviewer1Name:", "${{ steps.pick_random_reviewer.outputs.reviewer1Name }}")

      - name: Add Reviewers
        uses: madrapps/add-reviewers@v1
        with:
          reviewers: ${{ steps.pick_random_reviewer.outputs.reviewer1GithubName }},${{ steps.pick_random_reviewer.outputs.reviewer2GithubName }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Send Slack Trigger (retry)
        run: |
          payload=$(jq -n \
            --arg pullRequestLink "${{ steps.pick_random_reviewer.outputs.pullRequestLink }}" \
            --arg writer "${{ steps.pick_random_reviewer.outputs.writer }}" \
            --arg r1 "${{ steps.pick_random_reviewer.outputs.reviewer1Name }}" \
            --arg r2 "${{ steps.pick_random_reviewer.outputs.reviewer2Name }}" \
            '{pullRequestLink:$pullRequestLink, writer:$writer, reviewers:[$r1,$r2]}')

          echo "=== Slack payload ==="
          echo "$payload"

          for i in 1 2 3 4 5; do
            echo "Attempt $i"

            code=$(curl -sS -o response.txt -w "%{http_code}" \
              -H 'Content-Type: application/json' \
              -X POST "https://api-slack.internal.bcsdlab.com/api/review-request/frontend" \
              -d "$payload" || echo "000")

            echo "HTTP status: $code"
            echo "--- response body ---"
            cat response.txt || true
            echo "---------------------"

            if [ "$code" = "200" ]; then
              echo "Slack trigger succeeded"
              exit 0
            fi

            sleep $((i * 2))
          done

          echo "Slack trigger failed after retries"
          exit 1
